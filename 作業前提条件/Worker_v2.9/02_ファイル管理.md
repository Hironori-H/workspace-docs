# ファイル管理 - Worker用

## 📌 このモジュールについて

**用途**: Workspace構造、ファイル命名規則、出力ファイル管理、作業ログ記録
**必読条件**: ファイル作成・編集作業を行う際に必読
**関連モジュール**:
- `01_基本ルール.md` - 基本的な作業原則
- `04_デバッグ・トラブルシューティング規約.md` - デバッグ時のファイル管理

---

## 日付ベースのフォルダ構造

### 基本ルール
- 毎日の作業開始時に、その日の日付を使用したフォルダを作成する
- フォルダ名の形式: `YYYYMMDD` (例: `20251113`)
- その日に作成・編集するファイルは、すべてその日のフォルダに格納する

### フォルダ作成手順
1. 本日の日付を確認 (例: 2025年11月13日)
2. YYYYMMDD形式でフォルダ名を決定 (例: `20251113`)
3. ワークスペースルート (`C:\Users\CLPC-63\workspace`) に日付フォルダを作成
4. 以降の作業は、作成した日付フォルダ内で実施

### 過去のファイルを編集する場合のルール

**重要**: 別の日付のフォルダにあるファイルを修正・変更する必要がある場合は、以下の手順に従う:

1. **元のファイルは直接編集しない**
2. **当日の日付フォルダに新しいバージョンを作成**
3. **ファイル名に修正内容や元の日付を含める**

#### バージョニングルール

**セマンティックバージョニングを採用**:
- **マイナーバージョン (v1.1, v1.2, v1.3...)**: 細かい修正・変更
  - バグ修正
  - 軽微な追記・修正
  - コメントの追加
  - 小規模なリファクタリング

- **メジャーバージョン (v2, v3, v4...)**: 大きな変更
  - 機能の大幅な追加・削除
  - アルゴリズムの根本的な変更
  - 構造の大幅な変更
  - 互換性を損なう変更

**命名例**:
```
元ファイル: 20251112\現状分析_自動化の制約と障害.md

細かい修正の場合:
  20251113\現状分析_自動化の制約と障害_v1.1.md
  20251114\現状分析_自動化の制約と障害_v1.2.md

大きな変更の場合:
  20251113\現状分析_自動化の制約と障害_v2.md
  20251115\現状分析_自動化の制約と障害_v3.md
```

**プログラムファイルの例**:
```
元ファイル: 20251112\data_process.py

細かい修正: 20251113\data_process_v1.1.py
大きな変更: 20251113\data_process_v2.py
```

#### 理由
- 過去の作業履歴を保持
- 変更による影響を明確化
- バージョン管理と追跡が容易

#### 例外
以下のフォルダ内のファイルは直接編集可能:
- `DOCS/`: ドキュメントの継続的な更新が必要なため
- `batch_file/`: 共通スクリプトのメンテナンスのため
- `database_difinition/`: 定義ファイルの一元管理のため
- `usecase_difinition/`: 定義ファイルの一元管理のため

### フォルダ構造の例
```
C:\Users\CLPC-63\workspace\
├── 20251113\                    # 本日のフォルダ
│   ├── 20251113_worklog.md     # 作業ログ（必須）
│   ├── file1.txt
│   ├── script.py
│   ├── data_process_v2.py      # 20251112版を修正したもの
│   ├── test_data\              # テストデータ
│   └── log\                    # 出力・生成ファイル
├── 20251112\                    # 過去の作業フォルダ
│   ├── 20251112_worklog.md
│   └── data_process.py         # 元のバージョン（保持）
├── 20251111\
├── reject_file\                 # 削除候補ファイル
├── DOCS\                        # ドキュメント管理フォルダ
└── batch_file\                  # 共通スクリプト
```

## ワークスペース構造

### 固定フォルダ
以下のフォルダは日付に関係なく固定的に使用:

- `DOCS/`: ドキュメント、手順書、仕様書等の管理
- `batch_file/`: バッチファイル、スクリプトの保存
- `database_difinition/`: データベース定義関連
- `usecase_difinition/`: ユースケース定義関連
- `reject_file/`: 削除候補ファイルの一時保管場所

### 日付フォルダ (YYYYMMDD)
各日付フォルダには以下のような構成を推奨:

- `YYYYMMDD_worklog.md`: 作業ログ（必須）
- スクリプト、ソースコード
- `log/`: 出力・生成ファイル専用サブフォルダ
- `test_data/`: テストデータ専用サブフォルダ
- `error_YYYYMMDD_スクリプト名/`: エラー発生時の調査フォルダ

## ファイル命名規則

### 基本原則
- わかりやすく具体的な名前を使用
- スクリプトファイル（.py, .bat, .ps1等）は**英数字を強く推奨**
- ドキュメントファイル（.md, .txt等）は日本語可
- 複数の単語はアンダースコア `_` で区切る

### 例
```
# スクリプトファイル（英数字推奨）
good_example_001.py
launch_automation.bat
setup_config.ps1

# ドキュメントファイル（日本語可）
データ処理スクリプト説明.md
利用ガイド.txt
作業ログ_20251114.md
```

---

## 出力ファイル・生成ファイルの管理

### 基本ルール
スクリプトやプログラムが生成するファイル（CSV、JSON、ログ、レポート等）は、専用のサブフォルダに格納する。

### フォルダ構造
```
20251113\
├── 20251113_worklog.md
├── script.py
├── data_process.py
└── log\                    # 出力・生成ファイル専用
    ├── output_143052.csv
    ├── result_20251113.json
    ├── error.log
    └── report_summary.txt
```

### 命名規則
- タイムスタンプを含める: `output_20251113_143052.csv`
- 用途を明確に: `error.log`, `result.json`, `report_summary.txt`
- スクリプト名を含めても可: `data_process_output.csv`

### 注意事項
- 大容量ファイル（100MB以上）はGitにコミットしない
- 機密情報を含む出力ファイルは削除または暗号化
- ログファイルは定期的にクリーンアップ

---

## 作業ログ・メモの記録

### 必須ルール
**各日付フォルダには必ず作業ログファイルを作成する**

### ファイル形式
- ファイル名: `YYYYMMDD_worklog.md`
- 例: `20251113_worklog.md`
- 場所: 日付フォルダ直下

### テンプレート
```markdown
# 作業ログ - 2025年11月13日

## 作業目的
- [今日の主な作業目的を記載]

## 実施内容
1. [実施した作業1]
2. [実施した作業2]
3. [実施した作業3]

## 作成・修正したファイル
- `script.py`: [説明]
- `data_process_v2.py`: [説明]

## 課題・問題点
- [発生した課題や問題点]

## 次回タスク
- [ ] [次回やるべきこと1]
- [ ] [次回やるべきこと2]

## メモ・備考
- [その他気づいた点や重要な情報]
```

### メリット
- 作業の連続性を保てる
- 後から振り返りやすい
- チーム共有が容易

## 環境変数・設定ファイルの管理

### 機密情報を含むファイルの扱い
以下のファイルは**絶対にGitにコミットしない**:
- `.env`: 環境変数ファイル
- `config.json` (機密情報を含む場合)
- `credentials.json`: 認証情報
- `secrets.yaml`: シークレット情報
- API キー、パスワードを含むファイル

### 推奨される対応
1. **サンプルファイルを作成**
   - `.env.example`: 環境変数のテンプレート
   - `config.example.json`: 設定ファイルのテンプレート

2. **.gitignore に追加**
   ```
   .env
   credentials.json
   secrets.yaml
   **/config.json
   ```

3. **DOCSフォルダに設定方法を文書化**
   - `DOCS/環境設定手順.md` 等に記載

### 設定ファイルの格納場所
- プロジェクト固有の設定: プロジェクトルート
- 共通設定: `batch_file/` または `DOCS/`

## クリーンアップ・アーカイブ

### reject_file フォルダの活用
不要になったファイルや古い日付フォルダは、すぐに削除せず `reject_file` フォルダに移動する。

### フォルダ構造
```
C:\Users\CLPC-63\workspace\
├── reject_file\            # 削除候補ファイルの一時保管場所
│   ├── 20251101\          # 古い日付フォルダ
│   ├── old_script.py
│   └── deprecated_data.csv
├── 20251113\              # 現在の作業フォルダ
└── DOCS\
```

### 運用ルール
1. **移動の基準**
   - 30日以上経過した日付フォルダ
   - 不要になったファイル
   - 実験的なコードで失敗したもの

2. **削除の判断**
   - `reject_file` 内のファイルは手動で削除
   - 定期的に（月1回程度）レビューして削除を判断
   - 重要なファイルは念のため確認してから削除

3. **アーカイブ**
   - 長期保存が必要なものは ZIP 化
   - アーカイブ先: `archive/` フォルダまたは外部ストレージ

### 削除してはいけないファイル
- DOCSフォルダ内のドキュメント
- batch_file フォルダ内の共通スクリプト
- データベース定義、ユースケース定義
- 本番環境で使用中のファイル

## エラー発生時の対応プロトコル

### エラーログの保存

**フォルダ命名規則**:
```
YYYYMMDD/error_YYYYMMDD_スクリプト名/
```

**例**:
```
20251113\
├── 20251113_worklog.md
├── data_process.py
└── error_20251113_data_process\
    ├── error.log
    ├── traceback.txt
    ├── input_data_snapshot.csv
    └── 問題調査メモ.md
```

### エラーフォルダの内容
1. **error.log**: エラーメッセージの完全なログ
2. **traceback.txt**: スタックトレース
3. **input_data_snapshot**: エラー発生時の入力データ（コピー）
4. **問題調査メモ.md**: 原因調査の経緯と解決方法

### 対処手順
1. エラーが発生したら、まずエラーフォルダを作成
2. エラーログとトレースバックを保存
3. 問題調査メモを作成し、以下を記録:
   - エラー発生日時
   - 実行したコマンド・操作
   - エラーメッセージ
   - 推定される原因
   - 試した解決策
   - 最終的な解決方法

### ロールバック方法
- 過去の日付フォルダから正常に動作していたバージョンを参照
- Git履歴から以前のコミットを確認
- バックアップからの復元

## テストデータ・サンプルデータの管理

### フォルダ構造
各日付フォルダ内に `test_data/` サブフォルダを作成する。

```
20251113\
├── 20251113_worklog.md
├── script.py
├── test_data\              # テストデータ専用
│   ├── sample_input.csv
│   ├── expected_output.csv
│   └── test_config.json
└── log\
    └── test_result.txt
```

### 命名規則
- `sample_*.csv`: サンプルデータ
- `test_*.json`: テスト用設定
- `expected_*.txt`: 期待される出力結果
- `mock_*.py`: モックデータ生成スクリプト

### 注意事項
- **本番データと明確に区別する**
- テストデータには `_test` や `_sample` を付ける
- 本番データを誤って使用しないよう注意
- テストデータは小さいサイズに保つ（数KB～数MB）

### データの種類
1. **正常系データ**: 正しく動作するパターン
2. **異常系データ**: エラーハンドリングのテスト用
3. **境界値データ**: エッジケースのテスト用
4. **ダミーデータ**: 開発中の動作確認用

### 本番データの扱い
- 本番データは別の場所に保管
- テストで本番データを使う場合は、必ずコピーを作成
- 本番データは Git にコミットしない

## 作業開始時のチェックリスト

1. [ ] 本日の日付フォルダ (YYYYMMDD) が存在するか確認
2. [ ] 存在しない場合は作成
3. [ ] 作業ログファイル (`YYYYMMDD_worklog.md`) を作成
4. [ ] 作業内容に応じて適切なフォルダを選択
   - 恒久的なドキュメント → `DOCS/`
   - バッチファイル → `batch_file/`
   - その日の作業ファイル → `YYYYMMDD/`
5. [ ] 既存ファイルの確認・重複チェック

## Git管理

### 注意事項
- 現在のワークスペースはGitリポジトリ
- コミット前に必ず内容を確認
- 機密情報や一時ファイルはコミットしない

### 推奨される除外対象
- 大容量の出力ファイル
- 個人情報を含むファイル
- 一時的なテストファイル

## その他の推奨事項

### バックアップ管理規約

#### 基本方針

**最重要原則**: すべてのファイル修正において、修正前に必ずバックアップを取る。

#### バックアップ取得基準（2段階）

##### レベル1: 必須バックアップ（修正前）
- **対象**: すべてのコードファイル・設定ファイルの修正
- **タイミング**: 修正を開始する前
- **命名規則**: `[元のファイル名].backup_YYYYMMDD_[作業指示書の要約]_before`
- **例**: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before`

##### レベル2: 検証済みバックアップ（動作確認後）
- **対象**: 修正後、動作確認が完了したバージョン
- **タイミング**: テスト成功後、次の修正を開始する前
- **命名規則**: `[元のファイル名].backup_YYYYMMDD_[作業指示書の要約]_verified`
- **例**: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified`
- **重要**: このverifiedバージョンが次の修正のベースラインとなる

#### バックアップ取得手順

##### Workerの責任
1. 修正を開始する前に、必ずレベル1バックアップを作成
2. バックアップが作成されたことを確認
3. バックアップファイル名を作業ログに記録
4. 動作確認完了後、レベル2バックアップを作成
5. 作業ログに記録

##### 確認事項
- [ ] バックアップファイルが作成された
- [ ] ファイルサイズが0でない（空ファイルでない）
- [ ] バックアップファイル名が命名規則に従っている
- [ ] 作業ログにバックアップファイル名を記録した

#### バックアップの保存と管理

##### 保存場所
- **基本**: 元のファイルと同じディレクトリに保存
- **例外**: 大量のバックアップがある場合は `backups/YYYYMMDD/` に保存

##### 保存期間
- **レベル1（必須）**: 次の検証済みバックアップまで保持
- **レベル2（検証済み）**: 容量が許す限り無期限保持
- **クリーンアップ**: 容量が逼迫した場合のみ、ユーザー確認後に古いバックアップを削除

##### バックアップ対象
- **必須**: コードファイル（`.js`, `.jsx`, `.py`, `.bat`, `.ps1`）
- **必須**: 設定ファイル（`.json`, `.env`, `.config`, `.yaml`, `.ini`）
- **必須**: スクリプトファイル（`.sh`, `.cmd`）
- **必須**: ドキュメントファイル（`.md`）
- **必須**: ログファイル（`.log`, `.txt`）← 動作確認を保証するため

##### バックアップ対象外
- 一時ファイル（`*.tmp`, `*.temp`）
- 自動生成ファイル（`node_modules/`, `*.pyc`, `__pycache__/`）
- Git管理対象外のファイル
- ビルド成果物（`dist/`, `build/`）

##### 大容量ファイルの扱い
- **基準**: 1つで数GB以上、または複数で数百MB以上
- **対応**: Reviewerが作業指示書作成時にユーザーに確認
- **例**: データベースダンプ、.aepプロジェクト、動画ファイル等

#### 作業ログへの記録

##### テンプレート
```markdown
## バックアップ履歴

### [作業指示書の要約]（YYYY-MM-DD）

**作業指示書**: `YYYYMMDD_作業指示_[内容].md`

**バックアップファイル**:
- **レベル1（修正前）**: `[ファイル名].backup_YYYYMMDD_[要約]_before`
  - 作成日時: YYYY-MM-DD HH:MM
  - ファイルサイズ: XXX KB
  - 元ファイルの状態: [前回のverifiedバージョン]

- **レベル2（検証済み）**: `[ファイル名].backup_YYYYMMDD_[要約]_verified`
  - 作成日時: YYYY-MM-DD HH:MM
  - ファイルサイズ: XXX KB
  - 動作確認: ✅ 成功
```

#### バックアップの復元手順

```bash
# ステップ1: 現在のファイルをバックアップ（念のため）
copy "[元のファイル]" "[元のファイル].backup_before_restore_YYYYMMDD"

# ステップ2: バックアップから復元
copy "[バックアップファイル]" "[元のファイル]"

# ステップ3: 復元を確認
dir "[元のファイル]"

# ステップ4: 動作確認
# （テストを実施）
```

##### 復元の記録
```markdown
## ロールバック履歴

### [復元理由]（YYYY-MM-DD）

- **復元日時**: YYYY-MM-DD HH:MM
- **復元元**: `[バックアップファイル名]`
- **復元先**: `[元のファイル名]`
- **理由**: [詳細な理由]
- **復元前のバックアップ**: `[元のファイル].backup_before_restore_YYYYMMDD`
- **復元後の動作確認**: [✅ 成功 / ❌ 失敗]
```

#### 日付フォルダのアーカイブ
- 古い日付フォルダは適宜アーカイブフォルダに移動
- アーカイブ先: `workspace/archive/YYYY/MM-Month/`
- 例: `workspace/archive/2025/11-November/20251101/`

---

### ドキュメント
- 複雑な処理には必ずREADMEまたはコメントを追加
- 作業ログを残す習慣をつける

### 効率化
- 繰り返し作業はスクリプト化
- 共通処理は `batch_file/` に保存して再利用

---
