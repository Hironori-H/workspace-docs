# バックアップ基準の調査と提案

**作成日**: 2025-11-19
**作成者**: Claude Code (Reviewer)
**目的**: バックアップの明確な基準を定義し、作業前提条件に追加

---

## 現状の問題点

### 問題1: バックアップ基準が曖昧
現在の作業前提条件には、以下の曖昧な記載しかありません：

**作業前提条件_Worker.md（2113-2114行目）**:
```markdown
### バックアップ
- 重要なファイルは定期的にバックアップ
- 日付フォルダの古いものは適宜アーカイブ
```

**問題点**:
- ❌ 「重要なファイル」の定義がない
- ❌ 「定期的に」の頻度が不明
- ❌ いつバックアップを取るべきかの基準がない
- ❌ どのような状態のファイルをバックアップするかの基準がない

### 問題2: バックアップ取得の一貫性がない

**実態**（2025-11-19 調査結果より）:
| ファイル | バックアップ数 | 状況 |
|---------|--------------|------|
| SimpleTrigger.jsx | 6個 | ✅ 修正前に毎回バックアップ |
| aeExecutor.js | 3個 | △ 修正前に一部バックアップ |
| aepWatcher.js | 0個 | ❌ Reviewerが直接修正、バックアップなし |
| importer.js | 0個 | ❌ バックアップなし |

**推測される暗黙的な基準**:
1. SimpleTrigger.jsx: **常にバックアップ**（中核ファイルのため？）
2. aeExecutor.js: **重要な修正時にバックアップ**（一部のみ）
3. aepWatcher.js, importer.js: **バックアップなし**（軽微な修正と判断？）

→ **一貫性がなく、明確な基準が不在**

---

## 現在のバックアップ実態の分析

### SimpleTrigger.jsx のバックアップパターン（6個）

| # | バックアップファイル名 | 作成日 | バックアップを取った理由（推測） |
|---|----------------------|--------|--------------------------------|
| 1 | `backup_20251117` | 2025-11-17 | 最初の修正前（基準バージョン） |
| 2 | `backup_20251117_logger_fix` | 2025-11-17 | ロガー修正前 |
| 3 | `backup_20251117_json_fix` | 2025-11-17 | JSON修正前 |
| 4 | `backup_20251118_before_v2` | 2025-11-18 | v2修正前（テキストプロパティ基本取得） |
| 5 | `backup_20251118_v2_final` | 2025-11-18 | v2_final修正前（テキストプロパティ無効化） |
| 6 | `backup_20251119_before_dialog_closer` | 2025-11-19 | ダイアログクローズ機能追加前 |

**パターン**:
- ✅ **修正前に必ずバックアップ**
- ✅ **説明付きの命名**（何の修正前かを明記）
- ✅ **段階的にバックアップ**（1日に複数回修正する場合も、毎回バックアップ）

### aeExecutor.js のバックアップパターン（3個）

| # | バックアップファイル名 | 作成日 | バックアップを取った理由（推測） |
|---|----------------------|--------|--------------------------------|
| 1 | `backup_20251117` | 2025-11-17 | 最初の修正前（基準バージョン） |
| 2 | `backup_20251117_logger_fix` | 2025-11-17 | ロガー修正前 |
| 3 | `backup_20251119_before_dialog_closer` | 2025-11-19 | ダイアログクローズ機能追加前 |

**パターン**:
- △ **重要な修正時のみバックアップ**
- ✅ **説明付きの命名**
- ❌ **すべての修正でバックアップを取っていない**（SimpleTrigger.jsxと異なる）

### aepWatcher.js / importer.js のバックアップパターン（0個）

**パターン**:
- ❌ **バックアップなし**
- ❌ **Reviewerが直接修正**（役割違反）
- ❌ **修正記録がGitのみ**

---

## バックアップを取る/取らないの暗黙的基準（推測）

### 推測1: 「ファイルの重要度」基準
- **SimpleTrigger.jsx**: After Effectsのメインスクリプト → **最重要** → 常にバックアップ
- **aeExecutor.js**: Node.js側の中核ファイル → **重要** → 一部バックアップ
- **aepWatcher.js**: 監視機能 → **補助的** → バックアップなし
- **importer.js**: DB登録機能 → **補助的** → バックアップなし

**問題点**: 「補助的」なファイルも重要な修正が含まれている（importer.jsはusersテーブル削除という重大な変更）

### 推測2: 「修正の規模」基準
- **大規模修正**: バックアップを取る
- **軽微な修正**: バックアップを取らない

**問題点**: 「大規模」「軽微」の定義が不明確

### 推測3: 「動作確認済み」基準
- **動作確認済みのバージョン**: バックアップを取る
- **未確認・実験的バージョン**: バックアップを取らない

**問題点**: バックアップのタイミングが「修正前」であり、この基準とは矛盾

---

## 提案: 明確なバックアップ基準の定義

### 基本方針

**最重要原則**: すべてのファイル修正において、**修正前に必ずバックアップを取る**

**理由**:
1. 修正が失敗した場合の復旧手段
2. 修正前後の比較が容易
3. 段階的なロールバックが可能
4. Git以外のローカルバックアップとして機能

---

## 提案1: バックアップ取得基準（3段階）

### レベル1: 必須バックアップ（すべての修正）

**対象**: すべてのコードファイル・設定ファイルの修正

**取得タイミング**: 修正を開始する前

**命名規則**: `[元のファイル名].backup_YYYYMMDD_[修正内容の説明]`

**例**:
- `SimpleTrigger.jsx.backup_20251119_before_dialog_closer`
- `aepWatcher.js.backup_20251119_before_subfolder_support`
- `config.json.backup_20251119_before_path_change`

**対象外**:
- 一時ファイル（`*.tmp`, `*.temp`）
- ログファイル（`*.log`）
- 自動生成ファイル（`node_modules/`, `*.pyc`）

---

### レベル2: 検証済みバックアップ（動作確認後）

**対象**: 修正後、動作確認が完了したバージョン

**取得タイミング**: テスト成功後、次の修正を開始する前

**命名規則**: `[元のファイル名].backup_YYYYMMDD_[修正内容]_verified`

**例**:
- `SimpleTrigger.jsx.backup_20251118_v2_final_verified`
- `aeExecutor.js.backup_20251119_dialog_closer_verified`

**目的**:
- 動作確認済みのバージョンを明確に識別
- ロールバック時に安全なバージョンをすぐに特定

---

### レベル3: マイルストーンバックアップ（リリース前）

**対象**: リリース・デプロイ直前のバージョン

**取得タイミング**: Git コミット・プッシュの直前

**命名規則**: `[元のファイル名].backup_YYYYMMDD_release_[バージョン番号]`

**例**:
- `SimpleTrigger.jsx.backup_20251119_release_v2.0`
- `aeExecutor.js.backup_20251119_release_v1.5`

**目的**:
- リリースバージョンの確実な保存
- Git以外のローカルバックアップ
- 緊急ロールバック用

---

## 提案2: バックアップ取得手順の標準化

### 手順1: 作業指示書にバックアップ手順を含める（Reviewer）

**Reviewerの責任**:
- 修正指示書の「実装手順」に必ずバックアップ手順を記載
- バックアップの命名規則を指定

**テンプレート**:
```markdown
## 実装手順

### ステップ1: バックアップの作成
```bash
# [ファイル名] のバックアップ
copy "[元のパス]" "[元のパス].backup_YYYYMMDD_[修正内容]"
```

### ステップ2: 修正の実施
...
```

---

### 手順2: バックアップ作成を最初に実施（Worker）

**Workerの責任**:
- 修正を開始する前に、必ずバックアップを作成
- バックアップが作成されたことを確認
- バックアップファイル名を作業ログに記録

**確認事項**:
- [ ] バックアップファイルが作成された
- [ ] ファイルサイズが0でない（空ファイルでない）
- [ ] バックアップファイル名が命名規則に従っている
- [ ] 作業ログにバックアップファイル名を記録した

---

### 手順3: バックアップの検証（Worker）

**検証内容**:
```bash
# バックアップファイルが存在するか確認
dir "[バックアップファイルのパス]"

# ファイルサイズを確認（0バイトでないこと）
# 元のファイルとサイズが一致することを確認
```

---

## 提案3: バックアップファイルの管理

### 保存場所

**基本原則**: 元のファイルと同じディレクトリに保存

**理由**:
- バックアップと元ファイルの対応が明確
- 復元が容易
- ディレクトリごと削除しても、バックアップも一緒に削除される（意図しない残存を防ぐ）

**例外**: バックアップ専用ディレクトリを作成する場合
- `[プロジェクトルート]/backups/YYYYMMDD/` 形式
- 理由: 大量のバックアップで元ディレクトリが見づらくなる場合

---

### 保存期間

**レベル1（必須バックアップ）**: 次の検証済みバックアップまで保持
- 検証済みバージョンが作成されたら、それ以前の未検証バックアップは削除可

**レベル2（検証済みバックアップ）**: 30日間保持
- 30日以内のロールバック要求に対応

**レベル3（マイルストーンバックアップ）**: 永久保持
- リリースバージョンは削除しない
- アーカイブフォルダに移動可

---

### クリーンアップ

**定期的なクリーンアップ**（月次）:
1. 30日以上前の検証済みバックアップを削除
2. 未検証バックアップをすべて削除（最新の検証済みバックアップより古いもの）
3. マイルストーンバックアップをアーカイブフォルダに移動

**クリーンアップスクリプト**:
```bash
# 30日以上前のbackupファイルを削除（release以外）
find . -name "*.backup_*" -type f -mtime +30 ! -name "*_release_*" -delete
```

---

## 提案4: バックアップの復元手順

### 復元手順（標準）

```bash
# ステップ1: 現在のファイルをバックアップ（念のため）
copy "[元のファイル]" "[元のファイル].backup_before_restore_YYYYMMDD"

# ステップ2: バックアップから復元
copy "[バックアップファイル]" "[元のファイル]"

# ステップ3: 復元を確認
dir "[元のファイル]"

# ステップ4: 動作確認
# （テストを実施）
```

### 復元の記録

**作業ログに記録**:
```markdown
## ロールバック履歴
- **日時**: 2025-11-19 14:30
- **復元元**: SimpleTrigger.jsx.backup_20251118_v2_final_verified
- **復元先**: SimpleTrigger.jsx
- **理由**: ダイアログクローズ機能でエラーが発生したため
- **復元前のバックアップ**: SimpleTrigger.jsx.backup_before_restore_20251119
```

---

## 提案5: 作業前提条件への追加内容

### 追加セクション: 「バックアップ管理規約」

**作業前提条件_Worker.md** に以下を追加:

```markdown
## バックアップ管理規約

### 基本方針

**最重要原則**: すべてのファイル修正において、修正前に必ずバックアップを取る。

### バックアップ取得基準

#### レベル1: 必須バックアップ（すべての修正）
- **対象**: すべてのコードファイル・設定ファイルの修正
- **タイミング**: 修正を開始する前
- **命名規則**: `[元のファイル名].backup_YYYYMMDD_[修正内容の説明]`
- **例**: `SimpleTrigger.jsx.backup_20251119_before_dialog_closer`

#### レベル2: 検証済みバックアップ（動作確認後）
- **対象**: 修正後、動作確認が完了したバージョン
- **タイミング**: テスト成功後、次の修正を開始する前
- **命名規則**: `[元のファイル名].backup_YYYYMMDD_[修正内容]_verified`
- **例**: `SimpleTrigger.jsx.backup_20251118_v2_final_verified`

#### レベル3: マイルストーンバックアップ（リリース前）
- **対象**: リリース・デプロイ直前のバージョン
- **タイミング**: Git コミット・プッシュの直前
- **命名規則**: `[元のファイル名].backup_YYYYMMDD_release_[バージョン番号]`
- **例**: `SimpleTrigger.jsx.backup_20251119_release_v2.0`

### バックアップ取得手順

#### Workerの責任
1. 修正を開始する前に、必ずバックアップを作成
2. バックアップが作成されたことを確認
3. バックアップファイル名を作業ログに記録

#### 確認事項
- [ ] バックアップファイルが作成された
- [ ] ファイルサイズが0でない（空ファイルでない）
- [ ] バックアップファイル名が命名規則に従っている
- [ ] 作業ログにバックアップファイル名を記録した

### バックアップの保存と管理

#### 保存場所
- 基本: 元のファイルと同じディレクトリに保存
- 例外: 大量のバックアップがある場合は `backups/YYYYMMDD/` に保存

#### 保存期間
- **レベル1（必須）**: 次の検証済みバックアップまで保持
- **レベル2（検証済み）**: 30日間保持
- **レベル3（マイルストーン）**: 永久保持

#### クリーンアップ
- 月次で30日以上前の検証済みバックアップを削除
- 未検証バックアップは最新の検証済みバックアップより古いものを削除

### バックアップ対象外
- 一時ファイル（`*.tmp`, `*.temp`）
- ログファイル（`*.log`）
- 自動生成ファイル（`node_modules/`, `*.pyc`）
- Git管理対象外のファイル
```

---

### 追加セクション: 「修正指示書のテンプレート」

**作業前提条件_Reviewer.md** に以下を追加:

```markdown
## 修正指示書のテンプレート

すべての修正指示書には、以下のバックアップ手順を含めること。

### テンプレート

\`\`\`markdown
## 実装手順

### ステップ1: バックアップの作成

**重要**: 修正を開始する前に、必ずバックアップを作成してください。

\`\`\`bash
# [ファイル名] のバックアップ
copy "[元のパス]" "[元のパス].backup_YYYYMMDD_[修正内容]"
\`\`\`

**確認事項**:
- [ ] バックアップファイルが作成された
- [ ] ファイルサイズが0でない
- [ ] 作業ログにバックアップファイル名を記録した

### ステップ2: 修正の実施
...
\`\`\`
```

---

## まとめ

### 現状の問題
1. ❌ バックアップ基準が曖昧（「重要なファイル」「定期的に」の定義なし）
2. ❌ バックアップ取得の一貫性がない（SimpleTrigger.jsxは6個、aepWatcher.jsは0個）
3. ❌ 暗黙的な基準が存在するが、明文化されていない

### 提案内容
1. ✅ **すべての修正で必ずバックアップを取る**（レベル1: 必須バックアップ）
2. ✅ **動作確認後にも検証済みバックアップを取る**（レベル2: 検証済みバックアップ）
3. ✅ **リリース前にマイルストーンバックアップを取る**（レベル3: マイルストーンバックアップ）
4. ✅ **バックアップの命名規則を統一**（`backup_YYYYMMDD_[説明]`）
5. ✅ **保存期間を明確化**（必須: 次の検証済みまで、検証済み: 30日、マイルストーン: 永久）
6. ✅ **作業前提条件に明文化**（Worker/Reviewer両方に追加）

### 期待される効果
1. ✅ すべてのファイル修正で確実にバックアップが取られる
2. ✅ ロールバックが容易になる
3. ✅ 修正前後の比較が容易になる
4. ✅ 作業の一貫性が向上する
5. ✅ 新しいWorker/Reviewerへのオンボーディングが容易になる

---

**作成日**: 2025-11-19
**作成者**: Claude Code (Reviewer)
**次のステップ**: ユーザーの承認後、作業前提条件_Worker.md と作業前提条件_Reviewer.md に追加

