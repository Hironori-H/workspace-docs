# バックアップ基準（最終版）

**作成日**: 2025-11-19
**作成者**: Claude Code (Reviewer)
**承認者**: ユーザー
**目的**: バックアップの明確な基準を定義し、作業前提条件に追加

---

## バックアップ取得基準（2段階）

### **レベル1: 必須バックアップ（修正前）**

**対象**: すべてのコードファイル・設定ファイルの修正

**取得タイミング**: 修正を開始する**前**

**命名規則**: `[ファイル名].backup_YYYYMMDD_[作業指示書の要約]_before`

**例**:
- 作業指示書: `20251119_作業指示_AE自動化_ダイアログ自動クローズ機能追加.md`
- バックアップ: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before`

**目的**:
- 修正が失敗した場合の復旧手段
- どの作業指示書で修正されたかを明確化

---

### **レベル2: 検証済みバックアップ（動作確認後）**

**対象**: 修正後、動作確認が完了したバージョン

**取得タイミング**: テスト成功後、次の修正を開始する前

**命名規則**: `[ファイル名].backup_YYYYMMDD_[作業指示書の要約]_verified`

**例**:
- `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified`
- `aeExecutor.js.backup_20251119_ダイアログ自動クローズ_verified`

**目的**:
- 動作確認済みのバージョンを明確に識別
- 安全なロールバックポイント
- **次の修正のベースライン**（次の修正時、このverifiedバージョンが新しいレベル1の対象となる）

---

## バックアップのライフサイクル

### 例: SimpleTrigger.jsx の段階的修正

#### **修正1回目: ダイアログ自動クローズ機能追加**

1. **修正前**（レベル1作成）:
   ```
   SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before
   ```
   ↓ 修正作業実施

2. **動作確認後**（レベル2作成）:
   ```
   SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified
   ```
   → この `verified` バージョンが次の修正のベースラインとなる

---

#### **修正2回目: エラーハンドリング強化**

3. **修正前**（レベル1作成）:
   ```
   SimpleTrigger.jsx.backup_20251120_エラーハンドリング強化_before
   ```
   → このバックアップの元になるのは、前回の `verified` バージョン（現在のファイル）
   ↓ 修正作業実施

4. **動作確認後**（レベル2作成）:
   ```
   SimpleTrigger.jsx.backup_20251120_エラーハンドリング強化_verified
   ```
   → この `verified` バージョンが次の修正のベースラインとなる

---

#### **修正3回目: パフォーマンス最適化**

5. **修正前**（レベル1作成）:
   ```
   SimpleTrigger.jsx.backup_20251121_パフォーマンス最適化_before
   ```
   → このバックアップの元になるのは、前回の `verified` バージョン（現在のファイル）
   ↓ 修正作業実施

6. **動作確認後**（レベル2作成）:
   ```
   SimpleTrigger.jsx.backup_20251121_パフォーマンス最適化_verified
   ```

---

### 重要な原則

**レベル2（verified）が次のレベル1のベースラインとなる**:
- 前回の `verified` バージョン = 現在のファイル
- 現在のファイルを修正する前に、レベル1バックアップを作成
- これにより、常に動作確認済みのバージョンから修正を開始することになる

**保存されるバックアップ**（上記の例の場合）:
```
SimpleTrigger.jsx（現在のファイル）
SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before
SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified
SimpleTrigger.jsx.backup_20251120_エラーハンドリング強化_before
SimpleTrigger.jsx.backup_20251120_エラーハンドリング強化_verified
SimpleTrigger.jsx.backup_20251121_パフォーマンス最適化_before
SimpleTrigger.jsx.backup_20251121_パフォーマンス最適化_verified
```

---

## 命名規則の詳細

### パターン1: 作業指示書の要約を含める（推奨）

**命名規則**: `[ファイル名].backup_YYYYMMDD_[作業指示書の要約]_[before/verified]`

**作業指示書の要約の作り方**:
1. 作業指示書のファイル名から抽出
2. 日付部分を除外
3. 「作業指示」「修正指示」などの接頭辞を除外
4. 重要なキーワードのみを残す

**例**:
| 作業指示書ファイル名 | 要約 |
|---------------------|------|
| `20251119_作業指示_AE自動化_ダイアログ自動クローズ機能追加.md` | `ダイアログ自動クローズ` |
| `20251120_修正指示_AE自動化_エラーハンドリング強化.md` | `エラーハンドリング強化` |
| `20251121_作業指示_DB最適化_インデックス追加.md` | `DB最適化_インデックス追加` |

**バックアップファイル名の例**:
```
SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before
SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified
aeExecutor.js.backup_20251120_エラーハンドリング強化_before
aeExecutor.js.backup_20251120_エラーハンドリング強化_verified
```

---

### パターン2: 固有IDを使用（オプション）

**命名規則**: `[ファイル名].backup_YYYYMMDD_INST[連番]_[before/verified]`

**例**:
```
SimpleTrigger.jsx.backup_20251119_INST001_before
SimpleTrigger.jsx.backup_20251119_INST001_verified
aeExecutor.js.backup_20251120_INST002_before
aeExecutor.js.backup_20251120_INST002_verified
```

**作業指示書への記載**:
```markdown
## 作業指示書情報
- **作業指示書ID**: INST001
- **対象ファイル**: SimpleTrigger.jsx
```

→ **パターン1（要約を含める）を推奨**: 一目で内容が分かりやすい

---

## 保存期間

### 基本方針: 容量が許す限り保持

**保存期間**: 無期限（容量が許す限り）

**理由**:
- 過去のバージョンへのロールバックが必要になる場合がある
- バックアップファイルのサイズは比較的小さい（数KB〜数MB）
- ディスク容量が逼迫しない限り、削除しない

---

### クリーンアップの判断基準

**定期的な確認**（月次または四半期）:
1. ディスク容量を確認
2. 容量が逼迫している場合のみ、古いバックアップを削除
3. 削除する場合は、ユーザーに確認

**削除の優先順位**（容量が逼迫した場合）:
1. 最も古い `before` バックアップから削除
2. `verified` バックアップは最後まで残す
3. 最新の3〜5世代は必ず残す

**削除前の確認事項**:
- [ ] 削除対象のバックアップより新しい `verified` バージョンが存在する
- [ ] 削除対象のバックアップが直近3ヶ月以上前のもの
- [ ] ユーザーに削除の承認を得た

---

## バックアップ対象と対象外

### バックアップ対象

#### 必須バックアップ対象
- **コードファイル**: `.js`, `.jsx`, `.py`, `.bat`, `.ps1` など
- **設定ファイル**: `.json`, `.env`, `.config`, `.yaml`, `.ini` など
- **スクリプトファイル**: `.sh`, `.cmd` など
- **ドキュメントファイル**: `.md`（作業指示書、仕様書など）
- **ログファイル**: `.log`, `.txt`（動作確認を保証するログファイル）

#### 個別判断が必要なファイル（大容量ファイル）

**基準**:
- 1つで数GB以上
- 複数で数百MB以上

**対応**: Reviewerが個別に確認

**確認内容**:
- ファイルの重要性
- 再生成の可否
- バックアップの必要性

**例**:
- データベースダンプファイル（数GB）: ❓ 個別判断
- After Effects プロジェクトファイル（.aep）（数百MB）: ❓ 個別判断
- 動画ファイル（数GB）: ❓ 個別判断
- 大量の画像ファイル（合計数百MB）: ❓ 個別判断

**確認フロー**:
1. Reviewerが作業指示書作成時に大容量ファイルを確認
2. バックアップの必要性をユーザーに確認
3. 必要な場合のみバックアップ手順に含める

**作業指示書での記載例**:
```markdown
## バックアップ対象の確認

### 大容量ファイルの確認
- **ファイル**: test_project.aep（350MB）
- **確認事項**: このファイルをバックアップしますか？
- **ユーザー判断**: [待機中]
```

---

### バックアップ対象外

**対象外（自動生成ファイル）**:
- `node_modules/` ディレクトリ
- `*.pyc`, `__pycache__/` ディレクトリ
- `*.tmp`, `*.temp` 一時ファイル
- `.git/` ディレクトリ
- ビルド成果物（`dist/`, `build/`）

**理由**: 再生成可能なため

---

## バックアップ取得手順（標準化）

### Reviewerの責任（作業指示書作成時）

**ステップ1: 作業指示書の要約を決定**
- ファイル名から重要なキーワードを抽出
- バックアップファイル名に使用する要約を決定
- 作業指示書に明記

**ステップ2: バックアップ手順を作業指示書に記載**

**テンプレート**:
```markdown
## バックアップ情報

**作業指示書の要約**: ダイアログ自動クローズ

**バックアップファイル名**:
- レベル1（修正前）: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before`
- レベル2（検証済み）: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified`

---

## 実装手順

### ステップ1: バックアップの作成（レベル1: 必須）

**重要**: 修正を開始する前に、必ずバックアップを作成してください。

\`\`\`bash
# SimpleTrigger.jsx のバックアップ（レベル1: 修正前）
copy "C:\Users\CLPC-63\AE_Monitor\AE_Monitor_Desktop\Scripts\SimpleTrigger.jsx" "C:\Users\CLPC-63\AE_Monitor\AE_Monitor_Desktop\Scripts\SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before"
\`\`\`

**確認事項**:
- [ ] バックアップファイルが作成された
- [ ] ファイルサイズが0でない
- [ ] 作業ログにバックアップファイル名を記録した

### ステップ2: 修正の実施
...

### ステップ3: 動作確認

### ステップ4: バックアップの作成（レベル2: 検証済み）

**テスト成功後**: 検証済みバックアップを作成してください。

\`\`\`bash
# SimpleTrigger.jsx のバックアップ（レベル2: 検証済み）
copy "C:\Users\CLPC-63\AE_Monitor\AE_Monitor_Desktop\Scripts\SimpleTrigger.jsx" "C:\Users\CLPC-63\AE_Monitor\AE_Monitor_Desktop\Scripts\SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified"
\`\`\`

**確認事項**:
- [ ] 動作確認が完了している
- [ ] バックアップファイルが作成された
- [ ] 作業ログにバックアップファイル名を記録した
```

---

### Workerの責任（修正作業時）

**ステップ1: バックアップ作成（修正前）**
1. 作業指示書に記載されたバックアップコマンドを実行
2. バックアップファイルが作成されたことを確認
3. ファイルサイズが0でないことを確認
4. 作業ログに記録

**ステップ2: 修正作業実施**

**ステップ3: 動作確認**

**ステップ4: バックアップ作成（検証済み）**
1. 動作確認が成功したら、検証済みバックアップを作成
2. 作業指示書に記載されたバックアップコマンドを実行
3. バックアップファイルが作成されたことを確認
4. 作業ログに記録

**ステップ5: 完了報告**
- 作業ログに以下を記録：
  - 作成したバックアップファイル名（レベル1とレベル2）
  - 動作確認結果
  - 完了時刻

---

## 作業ログへの記録

### テンプレート

```markdown
## バックアップ履歴

### [作業指示書の要約]（YYYY-MM-DD）

**作業指示書**: `YYYYMMDD_作業指示_[内容].md`

**バックアップファイル**:
- **レベル1（修正前）**: `[ファイル名].backup_YYYYMMDD_[要約]_before`
  - 作成日時: YYYY-MM-DD HH:MM
  - ファイルサイズ: XXX KB
  - 元ファイルの状態: [前回のverifiedバージョン]

- **レベル2（検証済み）**: `[ファイル名].backup_YYYYMMDD_[要約]_verified`
  - 作成日時: YYYY-MM-DD HH:MM
  - ファイルサイズ: XXX KB
  - 動作確認: ✅ 成功
```

**例**:
```markdown
## バックアップ履歴

### ダイアログ自動クローズ（2025-11-19）

**作業指示書**: `20251119_作業指示_AE自動化_ダイアログ自動クローズ機能追加.md`

**バックアップファイル**:
- **レベル1（修正前）**: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_before`
  - 作成日時: 2025-11-19 10:00
  - ファイルサイズ: 45 KB
  - 元ファイルの状態: 20251118_v2_final_verified

- **レベル2（検証済み）**: `SimpleTrigger.jsx.backup_20251119_ダイアログ自動クローズ_verified`
  - 作成日時: 2025-11-19 15:30
  - ファイルサイズ: 48 KB
  - 動作確認: ✅ 成功（14ファイル全て処理完了）
```

---

## バックアップの復元手順

### 復元手順（標準）

```bash
# ステップ1: 現在のファイルをバックアップ（念のため）
copy "[元のファイル]" "[元のファイル].backup_before_restore_YYYYMMDD"

# ステップ2: バックアップから復元
copy "[バックアップファイル]" "[元のファイル]"

# ステップ3: 復元を確認
dir "[元のファイル]"

# ステップ4: 動作確認
# （テストを実施）
```

### 復元の記録

**作業ログに記録**:
```markdown
## ロールバック履歴

### [復元理由]（YYYY-MM-DD）

- **復元日時**: YYYY-MM-DD HH:MM
- **復元元**: `[バックアップファイル名]`
- **復元先**: `[元のファイル名]`
- **理由**: [詳細な理由]
- **復元前のバックアップ**: `[元のファイル].backup_before_restore_YYYYMMDD`
- **復元後の動作確認**: [✅ 成功 / ❌ 失敗]
```

---

## まとめ

### バックアップの2段階

1. **レベル1（必須）**: 修正前に必ず作成
2. **レベル2（検証済み）**: 動作確認後に作成

### 重要な原則

1. **すべての修正で必ずレベル1バックアップを取る**
2. **動作確認後は必ずレベル2バックアップを取る**
3. **レベル2（verified）が次の修正のベースラインとなる**
4. **命名規則に従い、作業指示書との紐付けを明確化**
5. **保存期間は容量が許す限り無期限**
6. **大容量ファイルは個別判断**
7. **ログファイルも動作確認を保証するため保持**

### 期待される効果

1. ✅ すべてのファイル修正で確実にバックアップが取られる
2. ✅ どの作業指示書で修正されたかが一目で分かる
3. ✅ 動作確認済みのバージョンから次の修正を開始できる
4. ✅ 段階的なロールバックが容易
5. ✅ 修正履歴の追跡が容易
6. ✅ 新しいWorker/Reviewerへのオンボーディングが容易

---

**作成日**: 2025-11-19
**作成者**: Claude Code (Reviewer)
**承認者**: ユーザー
**次のステップ**: 作業前提条件_Worker.md と作業前提条件_Reviewer.md に追加
