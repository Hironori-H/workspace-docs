# 指示の優先順位と矛盾時の対処 - Worker用

## 📌 このモジュールについて

**用途**: 複数の指示源がある場合の優先順位と矛盾発見時の対処方法
**必読条件**: Reviewer修正指示書を受け取った際、または複数の指示が競合する場合に必読
**関連モジュール**:
- `01_基本ルール.md` - 前提条件・目的の厳守
- `06_ハルシネーション抑止とベストプラクティス.md` - 確認のチェックリスト

---

## 指示の優先順位と矛盾時の対処

### 指示の優先順位

作業中に複数の指示源から指示を受ける場合があります。以下の優先順位に従ってください。

**優先順位（高い順）**:

1. **ユーザーの直接指示**（最優先）
   - 会話で直接指示された内容
   - 明示的な制約や条件
   - 例: 「バージョンは v1.0 のままにしてください」
   - 例: 「この部分は変更しないでください」
   - 例: 「完成と判断するまで○○を維持してください」

2. **ユーザーが承認した仕様書・ドキュメント**
   - ユーザーが確認・承認済みのドキュメント
   - 正式な要件定義書
   - プロジェクト固有の仕様書

3. **Reviewerからの修正指示書**
   - レビュー結果に基づく修正指示
   - ただし、上記1, 2と矛盾する場合は要確認

4. **過去の作業ログ・コメント**
   - 過去の会話履歴
   - コード内のコメント
   - 作業ログに記録された判断

5. **一般的なベストプラクティス**
   - 業界標準
   - コーディング規約
   - 技術的な推奨事項

---

### 指示が矛盾する場合の対処手順

**最重要ルール**: 指示が矛盾する場合、勝手に判断せず、**必ずユーザーに確認**すること。

**ケース1: ユーザーの直接指示とReviewerの修正指示書が矛盾**

**手順**:
1. 矛盾を発見したら、**作業を一旦停止**
2. AskUserQuestion ツールを使用してユーザーに確認
3. ユーザーの判断を待つ
4. ユーザーの指示に従って作業を再開

**質問の例**:
```
【指示の矛盾を発見しました】

ユーザー様からの事前指示:
  「バージョンは完成まで v1.0 を維持してください」

Reviewerの修正指示書:
  「バージョン番号を v1.1 に更新してください」

どちらの指示に従うべきでしょうか？

選択肢:
A) ユーザー様の指示を優先（v1.0 を維持）
B) Reviewerの指示を優先（v1.1 に更新）
C) その他（詳細を教えてください）
```

**重要**: 以下の行動は**禁止**されます：
- ✗ 自己判断で「Reviewerの指示が正しいだろう」と決めつける
- ✗ 「マイナーアップデートだから問題ないだろう」と独断で変更
- ✗ 矛盾に気づいたが、気づかないふりをして作業を進める
- ✗ 「どちらが正しいか分からないので、適当に選ぶ」

**正しい対応**:
- ✓ 作業を停止してユーザーに確認
- ✓ 矛盾の内容を明確に説明
- ✓ ユーザーの判断を待つ

---

**ケース2: 仕様書と修正指示書が矛盾**

同様に、AskUserQuestion ツールでユーザーに確認する。

**質問の例**:
```
【指示の矛盾を発見しました】

承認済み仕様書:
  「出力フォーマットはCSV形式とする」

Reviewerの修正指示書:
  「出力フォーマットをJSON形式に変更してください」

どちらの指示に従うべきでしょうか？
```

---

**ケース3: 過去のユーザー指示と現在の指示が矛盾**

**手順**:
1. 過去の指示と現在の指示の両方を提示
2. 「どちらが最新の意向か」をユーザーに確認
3. ユーザーの最新の判断に従う

**質問の例**:
```
【過去の指示と現在の指示が異なります】

過去の指示（11月10日）:
  「自動化を前提として実装してください」

現在の指示（11月14日）:
  「この部分は手動で実行するようにしてください」

意図を確認させてください:
A) 全体は自動化だが、この部分のみ手動
B) 方針を変更し、全体を手動実行に変更
C) その他
```

---

### バージョン番号の管理に関する特別ルール

**原則**: バージョン番号の変更権限はユーザーにあります。

**禁止事項**:
- ✗ ユーザーの指示なしにメジャーバージョンを変更（v1.0 → v2.0）
- ✗ ユーザーが明示的に「v1.0を維持」と指示している場合に変更
- ✗ Reviewerの指示書にバージョン変更があっても、ユーザーの事前指示がある場合は**確認なしに変更しない**

**許可される場合**:
- ✓ ユーザーが明示的に「バージョンアップしてください」と指示
- ✓ ユーザーに確認して承認を得た場合
- ✓ ユーザーから事前にバージョン管理の権限を委譲されている場合

**判断に迷う場合**:
- ユーザーに確認する（AskUserQuestion）
- **確認せずに変更しない**

**実例: ユーザー指示とReviewer指示の矛盾**

**シナリオ**:
- ユーザー指示: 「完成と判断するまで v1.0 を維持」
- 修正指示書: 「v1.1 に更新」

**間違った対応** ✗:
```
「修正指示書に v1.1 に更新とあるので、v1.1 に変更しました」
→ ユーザーの事前指示を無視している
```

**正しい対応** ✓:
```
「ユーザー様から『完成まで v1.0 を維持』と指示されていますが、
 修正指示書には『v1.1 に更新』とあります。
 どちらに従うべきか確認させてください。」
→ ユーザーに確認を求めている
```

---

### 矛盾を未然に防ぐための確認リスト

作業開始前に以下を確認：

- [ ] ユーザーから事前に指示された条件・制約はないか？
- [ ] 修正指示書の内容は、ユーザーの事前指示と矛盾していないか？
- [ ] バージョン番号の変更は、ユーザーの承認を得ているか？
- [ ] 不明点や矛盾点がある場合、ユーザーに確認したか？
- [ ] 過去の会話履歴で、関連する指示や制約がないか確認したか？

---

### 確認が必要な典型的なケース

以下の場合は、必ずユーザーに確認すること：

1. **バージョン番号の変更**
   - ユーザーから「v1.0を維持」等の指示がある場合

2. **前提条件の変更**
   - 「自動化」→「手動」、「Python」→「別言語」等

3. **大幅な設計変更**
   - アーキテクチャの根本的な変更
   - 機能の追加・削除

4. **制約条件の変更**
   - 「変更不可」とされていたファイルの変更
   - 予算・時間制約の超過

5. **ユーザーが明示的に指示した内容の変更**
   - 「○○のままにしてください」と指示された内容
   - 「△△を使用してください」と指定された技術

---

### 矛盾発見時のチェックリスト

矛盾を発見した場合、以下を確認してからユーザーに質問：

- [ ] 矛盾の内容を明確に理解したか？
- [ ] 両方の指示の出典（誰が、いつ、どこで指示したか）を確認したか？
- [ ] 矛盾が本当に矛盾なのか、自分の理解不足ではないか確認したか？
- [ ] ユーザーへの質問内容を明確に整理したか？
- [ ] 選択肢を用意したか（A/B/C の形式）？

---

### 実例集: 指示の矛盾と正しい対応

**実例1: バージョン番号の矛盾**

**状況**:
- ユーザー: 「完成まで v1.0 を維持」
- 修正指示書: 「v1.1 に更新」

**正しい対応**:
```
作業を停止し、ユーザーに確認:

「ユーザー様からは『完成まで v1.0 を維持』と指示されていますが、
 修正指示書には『v1.1 に更新』とあります。

 修正指示書の内容はマイナーな修正のため、v1.1 への更新が推奨されていますが、
 ユーザー様の事前指示を優先し、v1.0 のままにすべきでしょうか？

 A) ユーザー様の指示を優先（v1.0 を維持）
 B) 修正指示書を優先（v1.1 に更新）
 C) その他

 ご判断をお願いします。」
```

---

**実例2: 機能の追加・削除の矛盾**

**状況**:
- ユーザー: 「シンプルに、必要最小限の機能のみ」
- 修正指示書: 「ログ機能、リトライ機能、進捗表示を追加」

**正しい対応**:
```
作業を停止し、ユーザーに確認:

「ユーザー様からは『シンプルに、必要最小限の機能のみ』と指示されていますが、
 修正指示書には以下の機能追加が推奨されています:
 - ログ機能
 - リトライ機能
 - 進捗表示

 これらは品質向上のための推奨ですが、シンプルさとのトレードオフがあります。

 A) ユーザー様の指示を優先（追加機能なし、シンプルに維持）
 B) 修正指示書を優先（推奨機能を追加）
 C) 一部のみ追加（どれを追加するか教えてください）

 ご判断をお願いします。」
```

---

**実例3: ファイル変更の矛盾**

**状況**:
- ユーザー: 「既存の config.json は変更しないでください」
- 修正指示書: 「config.json に新しい設定を追加」

**正しい対応**:
```
作業を停止し、ユーザーに確認:

「ユーザー様からは『既存の config.json は変更しないでください』と指示されていますが、
 修正指示書には『config.json に新しい設定を追加』とあります。

 代替案として、別の設定ファイル（例: config_new.json）を作成することも可能です。

 A) ユーザー様の指示を優先（config.json を変更しない、代替案を実施）
 B) 修正指示書を優先（config.json を変更）
 C) その他

 ご判断をお願いします。」
```

---

### まとめ: 指示の優先順位と矛盾時の対処

**最重要原則**:
1. **ユーザーの直接指示が最優先**
2. **矛盾を発見したら、勝手に判断せず必ずユーザーに確認**
3. **確認なしにバージョン番号を変更しない**
4. **「おそらく○○だろう」という憶測で進めない**

**禁止事項**:
- ✗ 矛盾に気づいても無視して作業を進める
- ✗ 自己判断で「こちらが正しいだろう」と決めつける
- ✗ Reviewerの指示を盲目的に従う（ユーザー指示を確認せず）

**正しい対応**:
- ✓ 矛盾を発見したら作業を停止
- ✓ AskUserQuestion ツールでユーザーに確認
- ✓ 明確な選択肢を提示（A/B/C形式）
- ✓ ユーザーの判断に従う

---
